<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>FHIR DBs</title>

		<meta name="description" content="Slides for FHIR DevDays 2019; Redmond">
		<meta name="author" content="Nikolai Ryzhikov">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
    <style>
     h1, h2, h3 { color: #ea4a35!important; }
     .reveal section img { background: white; border: none; box-shadow: none; }
     hr {
      border-color: #e94a35;
      background-color: #e94a35;
      height: 0px
     }
     #logo {
       position: absolute;
       top: 40px;
       right: 60px;
       height: 60px;
       z-index: 1000;
     }
     #dd {
       background: no-repeat url('devdays.svg');
       position: absolute;
       top: 40px;
       left: 60px;
       z-index: 1000;
       height: 50px;
       width: 150px;
       padding-left: 56px;
       padding-top: 2px;
       font-size: 23px;
       color: #666;
     }

.reveal .controls .navigate-left, .reveal .controls .navigate-left.enabled
{
    border-right-color: #e94a35;
}
.reveal .controls .navigate-right, .reveal .controls .navigate-right.enabled

{
    border-left-color: #e94a35;
}
      </style>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>
  <img id="logo" src="health-samurai.png"></img>
  <div id="dd" > DevDays Redmond 2019</div>

		<div class="reveal">
			<div class="slides">

<section data-markdown><script type="text/template" >

## FHIR Databases

---

Nikolai Ryzhikov @ Health Samurai

@niquola (tw, gm, gh)

</script></section>

<section>

<img style="height: 100px;" src="health-samurai.png"/>

<h4 style="color: #555; font-family: 'Gotham Pro',Arial,sans-serif; font-size: 44px; margin: 60px 0;">
Let's implement your<br/> ideas in FHIR
</h4>

<style>
 .prods img {
    display: inline-blocks;
 }
</style>
<div class="prods">
  <img style="height: 33px; margin-right: 60px" src="aidbox.svg"/>
  <img src="fb.svg"/>
</div>

</script></section>


<section data-markdown><script type="text/template" >
### FHIR-native & FHIR-first

---

Use FHIR as component or platform

to build next-generation
systems

</script></section>

<section data-markdown><script type="text/template" >
### FHIR Persistence?

---
How to store & query FHIR resources?
</script></section>

<section data-markdown><script type="text/template" >

### SQL/Relational DBs

---

![](pt.png)

</script></section>

<section data-markdown><script type="text/template" >
### SQL/Relational DBs

----


```sql
CREATE TABLE patient (id, birthDate,...);
CREATE TABLE patient_name (pid, family, use, given?...);
CREATE TABLE patient_telecom (pid, system, value ...)
CREATE TABLE patient_address (pid, city...);
CREATE TABLE patient_photo (pid, ...);
CREATE TABLE patient_contact (pid, ...);
CREATE TABLE patient_contact_name (pid, p_cid ...);
CREATE TABLE patient_contact_address (pid, p_cid ...);
CREATE TABLE patient_communication (pid, ...);
.....

```

Normal form?  > 1000 tables 
</script></section>

<section data-markdown><script type="text/template" >
### SQL/Relational DBs

---


```sql
SELECT *
  FROM patient
  JOIN patient_name 
  JOIN patient_telecom
  JOIN patient_address 
  JOIN patient_photo
  JOIN patient_contact
  JOIN patient_contact_name
  JOIN patient_contact_address
  JOIN patient_communication
  .....

```

DBs 10x inserts and joins


</script></section>

<section data-markdown><script type="text/template" >
### Popular schema  - save blob!

---

Grahame's Server, HAPI JPA, Vonk, MS FHIR

```
CREATE TABLE resource (
  id,
  resource blob,
  ...
);

create table string_idx(res_id, value, ...);
create table date_idx(res_id, value, ...);
create table token_idx(res_id, value, ...);
```




</script></section>

<section data-markdown><script type="text/template" >
### FHIR Search
---

```
GET /Patient?name=john&birthdate=lt1980&active=true
```

![](sp.png)

</script></section>

<section data-markdown><script type="text/template" >
### FHIR Search
----

```yaml
resourceType: "SearchParameter"
id: "Patient.phone"
name: "phone"
type: "token"
expression: "Patient.telecom.where(system='phone')"
```

</script></section>

<section data-markdown><script type="text/template" >
![](indexing.png)
</script></section>

<section data-markdown><script type="text/template" >
### GET /Patient?phone=123

---

```sql
SELECT resource
FROM resource r
JOIN token_idx s1
  ON s1.res_id = id AND s1.name = 'phone'
WHERE
 r.type = 'Patient'
 AND s1.value = '123'

```

</script></section>

<section data-markdown><script type="text/template" >
![](reindex.png)
</script></section>

<section data-markdown><script type="text/template" >

### Store 3 times!

---

* as blob
* as search param entry
* as db idx

</script></section>

<section data-markdown><script type="text/template" >
### Multiple search params

---

```
GET /Patient?
 name=john&
 birthDate=lt1870&
 address=LA&
 ...
 &_sort=birthDate
```


```sql
SELECT resource
 FROM resource r
 JOIN string_idx s1
 JOIN date_idx d1
 JOIN address_idx d1
WHERE ...
SORT BY d1.value

```

</script></section>

<section data-markdown><script type="text/template" >
###  Performance & selecitvity
---

![](selectivity.png)

</script></section>


<section data-markdown><script type="text/template" >
### Document databases?

---

* mongodb
* couchdb

</script></section>


<section data-markdown><script type="text/template" >
### MongoDB

---

```
db.Patient.find( {
     status: active,
     $or: [ { birthDate: { $lt: 1980 } } ]
})
```

Search in db
</script></section>

<section data-markdown><script type="text/template" >
### Document DBs - Pros

---

* resources fit docs
* in db search
* clusters out of the box
</script></section>

<section data-markdown><script type="text/template" >
### Document DBs - Cons

---

* not mature as relational
* transactional integrity
* query expressiveness (SQL)


but it's changing

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox

---

hybrid approach: doc + sql

* Use JSONB
* Search on db layer
* Get the best from PostgreSQL

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox schema

---

```
CREATE TABLE patient (
  id text primary key,
  resource jsonb
  ...
);

CREATE TABLE encounter (
  id text primary key,
  resource jsonb
  ...
);
```

table per resource type

</script></section>

<section data-markdown><script type="text/template" >
### [JSONB in postgres](https://www.postgresql.org/docs/11/functions-json.html)

---

```
SELECT
 resource#>>'{name,0,given,0}' as first_name,
 resource#>>'{name,0,family}' as last_name,
 age(now(),(resource->>'birthDate')::timestamptz) as age
 FROM patient
```

accessing elements
</script></section>

<section data-markdown><script type="text/template" >
### Accessing elements

---

```
SELECT
 knife_extract(
  resource,
  '[["name","given"],["name","family"]]'
 ) as knife,
 FROM patient
 LIMIT 10
```

json_knife
</script></section>
<section data-markdown><script type="text/template" >
### FHIRPath in PG

---

```
SELECT
 fhirpath(resource, 'name.given | name.family') as fp,
 FROM patient
 LIMIT 10
```

fhirpath (alpha)
</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox search

---

```
SELECT * FROM patient
WHERE
  [expr] [operator] [value]
AND 
  [expr] [operator] [value]
```

expr - extract elements from resource

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox search

---

```
SELECT * FROM patient
WHERE
  timestamp(res->>'birthDate') > '1950' 
  AND timestamp(res->>'birthDate') > '1950' 
  AND extract(res, 'identifier.where(system = "mrn"))' = '1234'

```

search expressions in db
</script></section>

<section data-markdown><script type="text/template" >
### Functional Indices

---

```
CREATE index patient_mrn_idx
ON patient GIN (
  extract(resource, 'identifier.where(system = "mrn"))'
);
```

</script></section>


<section data-markdown><script type="text/template" >

### Indexing in DB
---
![](pgidx.png)

</script></section>

<section data-markdown><script type="text/template" >
### Advanced PG indexing

---

```

SELECT *
FROM patient
WHERE
 resource @> $${
  "gender": "female",
  "active": true,
  "identifier": [{"system":"mrn", "value": "000000013"}]}
 }$$

CREATE INDEX patient_jsonb_gin
ON patient USING GIN (
  resource jsonb_path_ops
);


```
inclusion  operator

</script></section>

<section data-markdown><script type="text/template" >
### [jsquery](https://github.com/postgrespro/jsquery)

---

```

SELECT *
FROM patient
WHERE
 resource @@ $${
   gender = 'female' and active = true,
   identifier.#.(
      system = 'mrn' 
      and
      value = '000000013'
   )
 }$$::jsquery

```

can be indexed with GIN & GIST

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox

---

* indexing in db (up 10 times faster)
* search any element any resource
* more space for optimization

</script></section>

<section data-markdown><script type="text/template" >
### SQL as second API
---

```
PUT /AidboxQuery/pts


query: |
  SELECT
  resource#>>'{name,0,given,0}' as first_name,
  resource#>>'{name,0,family}' as last_name,
  age(now(),(resource->>'birthDate')::timestamptz) as age
  FROM patient


GET /$query/pts

```

parameters

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase for other dbs

JSONpath in SQL standard

----
* Oracle
* PostgreSQL
* MSSQL
* MySQL

</script></section>

<section data-markdown><script type="text/template" >
### Analytics on FHIR
---

* [SQL on FHIR](https://github.com/FHIR/sql-on-fhir/blob/master/sql-on-fhir.md)
* [Analytics on FHIR](https://chat.fhir.org/#narrow/stream/179219-analytics-on.20FHIR)

</script></section>

<section data-markdown><script type="text/template" >
### SQL on FHIR
---

```
SELECT subject.reference,
       AVG(value.quantity.value) avg_hdl
FROM observation o,
     UNNEST(o.code.coding) c
WHERE c.system = 'http://loinc.org' AND
      c.code = '2085-9' AND
      o.effective.datetime > '2017'
GROUP BY subject.reference
```

</script></section>

<section data-markdown><script type="text/template" >
### Implementations

---
* [Bunsen: Spark SQL](https://engineering.cerner.com/bunsen/0.4.6/)
* [BigQuery on FHIR](https://cloud.google.com/healthcare/docs/how-tos/fhir-export-bigquery)
* [fhirbase: PostgreSQL](https://https://www.health-samurai.io/fhirbase)

</script></section>

<section data-markdown><script type="text/template" >
### Storage format
---
* structured references 
* fixed choice types
* first class extensions 

</script></section>

<section data-markdown><script type="text/template" >
### References
---
```
resourceType: 'Encounter'
subject:
  reference: 'Patient/pt-1'
-- to
subject:
  id: 'pt-1'
  resourceType: 'Patient'
  -- or
  patient_id: 'pt-1'

```
</script></section>

<section data-markdown><script type="text/template" >
### Choice / Union
---
```
resourceType: 'Observation'
valueQuantity: ???
--- to
value:
  Quantity:
    value: 120
    unit: 'mm Hg'

```
</script></section>

<section data-markdown><script type="text/template" >
### FC Extensions
---
```
resourceType: 'Patient'
extension:
- extensionUrl: 'http://...../race'
  extension:
  - valueCoding:
    extensionUrl: 'http://...../race-omb-category'
    code: 'white'
-- top
race:
  ombCategory:
    code: 'White'

```
</script></section>


<section data-markdown><script type="text/template" >
### Getting Started
---

[SQL on FHIR tutorials](https://github.com/fhir-fuel/fhir-storage-and-analytics-track)

[fhirbase online](https://fbdemo.aidbox.app/) ||  [aidbox online](https://fbdemo.aidbox.app/)

</script></section>

<section data-markdown><script type="text/template" >

### SQL + FHIR =  ‚ù§

</script></section>

<section data-markdown><script type="text/template">
## Thank you!

---

* Nicola (RIO) in zulip
* @niquola on github & twitter
* niquola@health-samurai.io

</script></section>



    <script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'convex', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
