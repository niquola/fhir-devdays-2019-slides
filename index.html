<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>fhir db</title>

		<meta name="description" content="Slides for netrika conf 2017 about FHIR">
		<meta name="author" content="Nikolai Ryzhikov">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css" id="theme">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
    <style>
     h1, h2, h3 { color: #ea4a35!important; }
     .reveal section img { background: white; border: none; box-shadow: none; }
      </style>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">
			<div class="slides">

<section data-markdown><script type="text/template" >

## FHIR Databases

---

Nikolai Ryzhikov @ Health Samurai

@niquola (tw, gm, gh)

</script></section>


<section data-markdown><script type="text/template" >
### FHIR-native & FHIR-first

---

Use FHIR as platform to build next-generation
systems

</script></section>

<section data-markdown><script type="text/template" >
### FHIR Persistence?

---
How to store & query FHIR resources?
</script></section>

<section data-markdown><script type="text/template" >

### SQL/Relational DBs

---

![](pt.png)

</script></section>

<section data-markdown><script type="text/template" >
### SQL/Relational DBs

----


```sql
CREATE TABLE patient (id, birthDate,...);
CREATE TABLE patient_name (pid, family, use, given?...);
CREATE TABLE patient_telecom (pid, system, value ...)
CREATE TABLE patient_address (pid, city...);
CREATE TABLE patient_photo (pid, ...);
CREATE TABLE patient_contact (pid, ...);
CREATE TABLE patient_contact_name (pid, p_cid ...);
CREATE TABLE patient_contact_address (pid, p_cid ...);
CREATE TABLE patient_communication (pid, ...);
.....

```
---

Normal form?  > 1000 tables 
</script></section>

<section data-markdown><script type="text/template" >
### SQL/Relational DBs

---


```sql
SELECT *
  FROM patient
  JOIN patient_name 
  JOIN patient_telecom
  JOIN patient_address 
  JOIN patient_photo
  JOIN patient_contact
  JOIN patient_contact_name
  JOIN patient_contact_address
  JOIN patient_communication
  .....

```
---
DBs 10x inserts and joins

</script></section>

<section data-markdown><script type="text/template" >
### Popular schema  - save blob!

---

```
create table resource (id, resource blob,...);
create table string_idx(res_id, value, ...);
create table date_idx(res_id, value, ...);
create table token_idx(res_id, value, ...);
```
---

Grahame's Server, HAPI JPA, Vonk, MS FHIR

</script></section>

<section data-markdown><script type="text/template" >
### Search Params
---

```yaml
resourceType: "SearchParameter"
id: "Patient.phone"
name: "phone"
type: "token"
expression: "Patient.telecom.where(system='phone')"

```

---
[Patient Search Params](https://www.hl7.org/fhir/patient.html#search)

</script></section>

<section data-markdown><script type="text/template" >
### How FHIR search works
----

```
filter: r in resources
   every: sp in search-params
     extract(r, sp.expr) op val

```

</script></section>

<section data-markdown><script type="text/template" >

### Materilized Indexing
---

1. write resource blob
2. eval search param
3. write sp table
4. build db idx

</script></section>

<section data-markdown><script type="text/template" >
![](indexing.png)
</script></section>

<section data-markdown><script type="text/template" >
### GET /Patient?phone=123

---

```sql
SELECT resource
FROM resource r
JOIN token_idx s1
  ON s1.res_id = id AND s1.name = 'phone'
WHERE
 r.type = 'Patient'
 AND s1.value = '123'

```

</script></section>

<section data-markdown><script type="text/template" >
![](reindex.png)
</script></section>

<section data-markdown><script type="text/template" >

### Store 3 times!

---

* as blob
* as search param entry
* as db idx

</script></section>

<section data-markdown><script type="text/template" >
### Too much Joins

---

```
GET /Patient?
 name=john&
 birthDate=lt1870&
 address=LA&
 ...
 &_sort=birthDate
```


```sql
SELECT resource
 FROM resource r
 JOIN string_idx s1
 JOIN date_idx d1
 JOIN address_idx d1
WHERE ...
SORT BY d1.value

```

</script></section>

<section data-markdown><script type="text/template" >
###  Performance & selecitvity
---

![](selectivity.png)

</script></section>


<section data-markdown><script type="text/template" >
### Document databases?

---

* monogodb
* couchdb

</script></section>


<section data-markdown><script type="text/template" >
### MongoDB

---

```
db.Patient.find( {
     status: active,
     $or: [ { birthDate: { $lt: 1980 } } ]
})
```
--- 

Search in db
</script></section>

<section data-markdown><script type="text/template" >
### Document DBs +

---

* resources fit docs
* in db search
* clusters out of the box
</script></section>

<section data-markdown><script type="text/template" >
### Document DBs -

---

* not mature as relational
* transactional interity
* query expressivenes (SQL)

---

but it's changing

</script></section>

<section data-markdown><script type="text/template" >
### Hybride: JSON + SQL
---

best of both worlds

---

JSON path in latest [SQL standard](https://obartunov.livejournal.com/200076.html)

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox

---

* PostgreSQL only
* JSONB
* Functional Indexes

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox schema

---

```
CREATE TABLE patient (
  id text primary key,
  resource jsonb
  ...
);

CREATE TABLE encounter (
  id text primary key,
  resource jsonb
  ...
);
```

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox search

---

```
SELECT * FROM patient
WHERE
  timestamp(res->>'birthDate') > '1950' 
  AND timestamp(res->>'birthDate') > '1950' 
  AND extract(res, 'identifier.where(system = "mrn"))' = '1234'

```
---
search expressions in db
</script></section>

<section data-markdown><script type="text/template" >
### Functional Indices

---

```
CREATE index patient_mrn_idx
ON patient GIN (
  extract(resource, 'identifier.where(system = "mrn"))'
);
```
---

* jsonknife
* jsquery
* jsnonpath
* fhirpath.pg (betta)

</script></section>

<section data-markdown><script type="text/template" >

### Indexing in DB
---
![](pgidx.png)

</script></section>

<section data-markdown><script type="text/template" >
### Advanced PG indexing

---

```

SELECT *
FROM patient
WHERE
 resource @> $${
  "gender": "female",
  "active": true,
  "identifier": [{"system":"mrn", "value": "000000013"}]}
 }$$

CREATE INDEX patient_jsonb_gin
ON patient USING GIN (
  resource jsonb_path_ops
);


```
</script></section>

<section data-markdown><script type="text/template" >
### fhirbase/aidbox

---

* indixing in db (10 times faster)
* search without indices
* any element any resource
* more space for optimization

</script></section>

<section data-markdown><script type="text/template" >
### SQL on FHIR
---

* FHIR search is not enough
* [Analytics on FHIR](https://chat.fhir.org/#narrow/stream/179219-analytics-on.20FHIR)

---

[SQL on FHIR Spec](https://github.com/FHIR/sql-on-fhir/blob/master/sql-on-fhir.md)

</script></section>

<section data-markdown><script type="text/template" >
### Solutions

---
* [bunsen: Spark SQL](https://engineering.cerner.com/bunsen/0.4.6/)
* [BigQuery on FHIR](https://cloud.google.com/healthcare/docs/how-tos/fhir-export-bigquery)
* [fhirbase: PostgreSQL](https://https://www.health-samurai.io/fhirbase)

</script></section>

<section data-markdown><script type="text/template" >
### Storage format
---
* structured references 
* fixed choice types
* first class extensions 

</script></section>

<section data-markdown><script type="text/template" >
### fhirbase demo
---

https://fbdemo.aidbox.app/

-- or --

https://aidbox.app

</script></section>


<section data-markdown><script type="text/template">
## Thank you!

---

* Nicola (RIO) in zulip
* @niquola on github & twitter
* niquola@health-samurai.io

</script></section>



    <script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'convex', // none/fade/slide/convex/concave/zoom

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
